<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Panel - Sistem Kabin Kapal</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <!-- React & Babel CDN -->
        <script
            src="https://unpkg.com/react@18/umd/react.development.js"
            crossorigin
        ></script>
        <script
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
            crossorigin
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <!-- Firebase Compat SDKs -->
        <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
        <!-- Tone.js for sound effects -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
        </style>
    </head>
    <body class="bg-gray-100">
        <div id="root"></div>

        <script type="text/javascript">
            // --- YOUR FIREBASE CONFIGURATION IS INCLUDED ---
            const firebaseConfig = {
                apiKey: "AIzaSyDVvdwyTXNZC0cFrwrLI2oq47uvbbtTtzw",
                authDomain: "project-moksha-a59af.firebaseapp.com",
                projectId: "project-moksha-a59af",
                storageBucket: "project-moksha-a59af.appspot.com",
                messagingSenderId: "565916093642",
                appId: "1:565916093642:web:9f3e6b03b1790e8b793833",
                measurementId: "G-LBL8336HC6",
            };
            // ----------------------------------------------------
            window.__firebase_config = JSON.stringify(firebaseConfig);
            window.__app_id = firebaseConfig.appId;
        </script>

        <script type="text/babel">
            // --- React Hooks ---
            const { useState, useEffect, createContext, useContext, useRef } =
                React;

            // --- Contexts ---
            const AppContext = createContext();
            const LanguageContext = createContext();

            // --- Translation System ---
            const translations = {
                en: {
                    adminPanelTitle: "ðŸš¢ Admin Panel",
                    passwordPlaceholder: "Enter Password",
                    login: "Login",
                    wrongPassword: "Wrong password.",
                    captainPanel: "Captain's Panel",
                    roomCalls: "Room Calls",
                    manageOrders: "Manage Orders",
                    manageMenu: "Manage Menu",
                    manageRooms: "Manage Rooms",
                    manageChat: "Manage Chat",
                    logout: "Logout",
                    callsFromRoom: "Calls from Room",
                    noCurrentCalls: "No current calls.",
                    emergencyCall: "Emergency Call!",
                    needsAssistance: "needs assistance.",
                    markAsDone: "Mark as Done",
                    all: "All",
                    new: "New",
                    processing: "Processing",
                    completed: "Completed",
                    cancelled: "Cancelled",
                    noOrdersWithStatus: "No orders with status",
                    orderFromRoom: "Order from Room",
                    notes: "Notes:",
                    total: "Total:",
                    status: "Status:",
                    addNewRoom: "Add New Room",
                    roomName: "Room Name (e.g., ROOM 11)",
                    title: "Title",
                    displayName: "Display Name (e.g., Jasmine Room)",
                    addRoom: "Add Room",
                    roomList: "Room List",
                    displayLabel: "Display Name:",
                    notSet: "(Not set)",
                    edit: "Edit",
                    delete: "Delete",
                    editRoomDetails: "Edit Room Details",
                    enterNewName: "Enter new name",
                    cancel: "Cancel",
                    save: "Save",
                    confirmDeleteRoom: "Are you sure you want to delete room",
                    thisActionCannotBeUndone: "This action cannot be undone.",
                    addNewMenuItem: "Add New Menu Item",
                    editMenuItem: "Edit Menu Item",
                    itemNamePlaceholder: "Item Name (e.g., Fried Noodles)",
                    pricePlaceholder: "Price (0 for Free)",
                    descriptionPlaceholder: "Description (Optional)",
                    category: "Category",
                    addons: "Add-ons",
                    addonNamePlaceholder: "Add-on Name (e.g., Egg)",
                    addonPricePlaceholder: "Add-on Price",
                    addAddon: "Add Add-on",
                    saveChanges: "Save Changes",
                    addItem: "Add Item",
                    menuList: "Menu List",
                    confirmDeleteItem:
                        "Are you sure you want to delete the item",
                    messagesFromRoom: "Messages from Room",
                    chooseRoomToSeeConversation:
                        "Choose a room to see the conversation.",
                    chatWithRoom: "Chat with Room",
                    clearChat: "Clear Chat",
                    typeReply: "Type a reply...",
                    send: "Send",
                    confirmClearChat:
                        "Are you sure you want to delete all chats from Room",
                    newOrderNotification: "New Order!",
                    roomOrdered: "Room",
                    status_Baru: "New",
                    status_Diproses: "Processing",
                    status_Selesai: "Completed",
                    status_Dibatalkan: "Cancelled",
                    notifications: "Notifications",
                    noNewNotifications: "No new notifications.",
                    uploadSuccess: "Schedule saved successfully!",
                    uploadFailed: "Failed to save schedule.",
                    saving: "Saving...",
                    imageUrl: "Image URL",
                    imageUrlPlaceholder: "Paste the image link here",
                    emailPlaceholder: "Email",
                    register: "Register",
                    haveAccount: "Already have an account? Login",
                    noAccount: "Don't have an account? Register",
                    noAdminAccess: "You do not have admin access.",
                    confirm: "Confirm",
                    orderCancelledNotification: "Order Cancelled!",
                    roomCancelledAnOrder: "cancelled an order.",
                },
                id: {
                    adminPanelTitle: "ðŸš¢ Panel Admin",
                    passwordPlaceholder: "Masukkan Kata Sandi",
                    login: "Masuk",
                    wrongPassword: "Kata sandi salah.",
                    captainPanel: "Panel Kapten",
                    roomCalls: "Panggilan Kamar",
                    manageOrders: "Kelola Pesanan",
                    manageMenu: "Kelola Menu",
                    manageRooms: "Kelola Kamar",
                    manageChat: "Kelola Chat",
                    logout: "Logout",
                    callsFromRoom: "Panggilan dari Kamar",
                    noCurrentCalls: "Tidak ada panggilan saat ini.",
                    emergencyCall: "Panggilan Darurat!",
                    needsAssistance: "membutuhkan bantuan.",
                    markAsDone: "Tandai Selesai",
                    all: "Semua",
                    new: "Baru",
                    processing: "Diproses",
                    completed: "Selesai",
                    cancelled: "Dibatalkan",
                    noOrdersWithStatus: "Tidak ada pesanan dengan status",
                    orderFromRoom: "Pesanan dari Kamar",
                    notes: "Catatan:",
                    total: "Total:",
                    status: "Status:",
                    addNewRoom: "Tambah Kamar Baru",
                    roomName: "Nama Kamar (e.g., KAMAR 11)",
                    title: "Gelar",
                    displayName: "Nama Tampilan (e.g., Kamar Melati)",
                    addRoom: "Tambah Kamar",
                    roomList: "Daftar Kamar",
                    displayLabel: "Nama Tampilan:",
                    notSet: "(Belum diatur)",
                    edit: "Ubah",
                    delete: "Hapus",
                    editRoomDetails: "Ubah Detail Kamar",
                    enterNewName: "Masukkan nama baru",
                    cancel: "Batal",
                    save: "Simpan",
                    confirmDeleteRoom: "Anda yakin ingin menghapus kamar",
                    thisActionCannotBeUndone:
                        "Tindakan ini tidak dapat dibatalkan.",
                    addNewMenuItem: "Tambah Item Menu Baru",
                    editMenuItem: "Ubah Item Menu",
                    itemNamePlaceholder: "Nama Item (e.g., Indomie Goreng)",
                    pricePlaceholder: "Harga (0 untuk Gratis)",
                    descriptionPlaceholder: "Deskripsi (Opsional)",
                    category: "Kategori",
                    addons: "Add-ons",
                    addonNamePlaceholder: "Nama Add-on (e.g., Telur)",
                    addonPricePlaceholder: "Harga Add-on",
                    addAddon: "Tambah Add-on",
                    saveChanges: "Simpan Perubahan",
                    addItem: "Tambah Item",
                    menuList: "Daftar Menu",
                    confirmDeleteItem: "Anda yakin ingin menghapus item",
                    messagesFromRoom: "Pesan dari Kamar",
                    chooseRoomToSeeConversation:
                        "Pilih kamar untuk melihat percakapan.",
                    chatWithRoom: "Chat dengan Kamar",
                    clearChat: "Bersihkan Chat",
                    typeReply: "Ketik balasan...",
                    send: "Kirim",
                    confirmClearChat:
                        "Anda yakin ingin menghapus semua chat dari Kamar",
                    newOrderNotification: "Pesanan Baru!",
                    roomOrdered: "Kamar",
                    status_Baru: "Baru",
                    status_Diproses: "Diproses",
                    status_Selesai: "Selesai",
                    status_Dibatalkan: "Dibatalkan",
                    notifications: "Notifikasi",
                    noNewNotifications: "Tidak ada notifikasi baru.",
                    uploadSuccess: "Jadwal berhasil disimpan!",
                    uploadFailed: "Gagal menyimpan jadwal.",
                    saving: "Menyimpan...",
                    imageUrl: "URL Gambar",
                    imageUrlPlaceholder: "Tempel link gambar di sini",
                    emailPlaceholder: "Email",
                    register: "Daftar",
                    haveAccount: "Sudah punya akun? Masuk",
                    noAccount: "Belum punya akun? Daftar",
                    noAdminAccess: "Anda tidak memiliki hak akses admin.",
                    confirm: "Konfirmasi",
                    orderCancelledNotification: "Pesanan Dibatalkan!",
                    roomCancelledAnOrder: "membatalkan pesanan.",
                },
            };

            function LanguageProvider({ children }) {
                const [language, setLanguage] = useState("en"); // Default language set to English
                const t = (key) => translations[language][key] || key;
                return (
                    <LanguageContext.Provider
                        value={{ language, setLanguage, t }}
                    >
                        {children}
                    </LanguageContext.Provider>
                );
            }
            function useTranslation() {
                return useContext(LanguageContext);
            }

            const FlagUK = () => (
                <svg className="w-6 h-6" viewBox="0 0 60 30">
                    <clipPath id="a">
                        <path d="M0 0v30h60V0z" />
                    </clipPath>
                    <path d="M0 0v30h60V0z" fill="#012169" />
                    <path
                        d="M0 0l60 30m0-30L0 30"
                        stroke="#fff"
                        strokeWidth="6"
                    />
                    <path
                        d="M0 0l60 30m0-30L0 30"
                        clipPath="url(#a)"
                        stroke="#C8102E"
                        strokeWidth="4"
                    />
                    <path d="M30 0v30M0 15h60" stroke="#fff" strokeWidth="10" />
                    <path
                        d="M30 0v30M0 15h60"
                        stroke="#C8102E"
                        strokeWidth="6"
                    />
                </svg>
            );
            const FlagIndonesia = () => (
                <svg className="w-6 h-6" viewBox="0 0 900 600">
                    <path fill="#e70011" d="M0 0h900v300H0z" />
                    <path fill="#fff" d="M0 300h900v300H0z" />
                </svg>
            );

            function App() {
                const [user, setUser] = useState(null);
                const [isAdmin, setIsAdmin] = useState(false);
                const [db, setDb] = useState(null);
                const [storage, setStorage] = useState(null);
                const [auth, setAuth] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);
                const [error, setError] = useState(null);
                const logoUrl =
                    "https://raw.githubusercontent.com/michaellay19/MOKSHA/main/MOKSHA%20PRADANA%20LOGO%20PRIMARY.png";

                useEffect(() => {
                    try {
                        const config = JSON.parse(
                            window.__firebase_config || "{}"
                        );
                        if (!config.apiKey) {
                            setError("Firebase configuration not found.");
                            setIsAuthReady(true);
                            return;
                        }
                        const app = firebase.initializeApp(config);
                        const authInstance = firebase.auth(app);
                        const dbInstance = firebase.firestore(app);
                        setDb(dbInstance);
                        setStorage(firebase.storage(app));
                        setAuth(authInstance);

                        const unsubscribe = authInstance.onAuthStateChanged(
                            async (user) => {
                                if (user && !user.isAnonymous) {
                                    const adminRef = dbInstance
                                        .collection("admins")
                                        .doc(user.uid);
                                    const doc = await adminRef.get();
                                    if (doc.exists) {
                                        setIsAdmin(true);
                                    } else {
                                        setIsAdmin(false);
                                        authInstance.signOut();
                                    }
                                } else {
                                    setIsAdmin(false);
                                }
                                setUser(user);
                                setIsAuthReady(true);
                            }
                        );

                        return () => unsubscribe();
                    } catch (e) {
                        console.error("Firebase initialization error:", e);
                        setError("Failed to load Firebase. Check console.");
                        setIsAuthReady(true);
                    }
                }, []);

                const handleLogout = () => {
                    auth.signOut();
                };

                if (!isAuthReady)
                    return (
                        <div className="min-h-screen flex items-center justify-center">
                            Connecting to service...
                        </div>
                    );
                if (error)
                    return (
                        <div className="min-h-screen flex items-center justify-center p-4 bg-red-100 text-red-700">
                            {error}
                        </div>
                    );

                return (
                    <LanguageProvider>
                        <AppContext.Provider
                            value={{
                                db,
                                storage,
                                auth,
                                appId: window.__app_id,
                                logoUrl,
                            }}
                        >
                            {user && isAdmin ? (
                                <AdminDashboard onLogout={handleLogout} />
                            ) : (
                                <AdminLogin />
                            )}
                        </AppContext.Provider>
                    </LanguageProvider>
                );
            }

            function AdminLogin() {
                const { auth, db, logoUrl } = useContext(AppContext);
                const { t } = useTranslation();
                const [password, setPassword] = useState("");
                const [error, setError] = useState("");
                const [loading, setLoading] = useState(false);
                const adminEmail = "admin@gmail.com"; // Hardcoded admin email

                const handleLogin = async () => {
                    if (!password) {
                        setError("Password is required.");
                        return;
                    }
                    setLoading(true);
                    setError("");
                    try {
                        const userCredential =
                            await auth.signInWithEmailAndPassword(
                                adminEmail,
                                password
                            );
                        const adminRef = db
                            .collection("admins")
                            .doc(userCredential.user.uid);
                        const doc = await adminRef.get();
                        if (!doc.exists) {
                            await auth.signOut();
                            setError(t("noAdminAccess"));
                        }
                        if (Tone.context.state !== "running") {
                            await Tone.start();
                        }
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-800 to-gray-900">
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                            <img
                                src={logoUrl}
                                alt="Moksha Logo"
                                className="mx-auto h-10 w-auto mb-4"
                            />

                            {error && (
                                <p className="text-red-500 text-center mb-4">
                                    {error}
                                </p>
                            )}
                            <div className="space-y-4">
                                <input
                                    type="password"
                                    placeholder={t("passwordPlaceholder")}
                                    value={password}
                                    onChange={(e) =>
                                        setPassword(e.target.value)
                                    }
                                    onKeyPress={(e) =>
                                        e.key === "Enter" && handleLogin()
                                    }
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                                />
                            </div>
                            <button
                                onClick={handleLogin}
                                disabled={loading}
                                className="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-blue-400"
                            >
                                {loading ? "..." : t("login")}
                            </button>
                        </div>
                    </div>
                );
            }

            function ConfirmationModal({ message, onConfirm, onCancel, show }) {
                const { t } = useTranslation();
                if (!show) return null;
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                            <p className="text-lg text-gray-800 mb-6">
                                {message}
                            </p>
                            <div className="flex justify-center space-x-4">
                                <button
                                    onClick={onCancel}
                                    className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                                >
                                    {t("cancel")}
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                                >
                                    {t("confirm")}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Icon Components ---
            const BellIcon = () => (
                <svg
                    className="w-12 h-12 mb-2 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                    ></path>
                </svg>
            );
            const ClipboardListIcon = () => (
                <svg
                    className="w-12 h-12 mb-2 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    ></path>
                </svg>
            );
            const MenuIcon = () => (
                <svg
                    className="w-12 h-12 mb-2 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M4 6h16M4 12h16M4 18h7"
                    ></path>
                </svg>
            );
            const KeyIcon = () => (
                <svg
                    className="w-12 h-12 mb-2 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M15.5 7.5l4.5-4.5M12 10a2 2 0 11-4 0 2 2 0 014 0zM8.5 16.5l-3-3a6 6 0 018.485-8.485l3 3a6 6 0 01-8.485 8.485l-3-3z"
                    ></path>
                </svg>
            );
            const ChatIcon = () => (
                <svg
                    className="w-12 h-12 mb-2 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                    ></path>
                </svg>
            );
            const BackIcon = () => (
                <svg
                    className="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"
                    ></path>
                </svg>
            );
            const LogoutIcon = () => (
                <svg
                    className="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                    ></path>
                </svg>
            );

            function MainMenu({ setActiveTab, counts }) {
                const { t } = useTranslation();

                const menuItems = [
                    {
                        id: "panggilan",
                        label: t("roomCalls"),
                        icon: <BellIcon />,
                        count: counts.calls,
                        color: "red",
                    },
                    {
                        id: "pesanan",
                        label: t("manageOrders"),
                        icon: <ClipboardListIcon />,
                        count: counts.orders,
                        color: "blue",
                    },
                    {
                        id: "menu",
                        label: t("manageMenu"),
                        icon: <MenuIcon />,
                        count: 0,
                    },
                    {
                        id: "kamar",
                        label: t("manageRooms"),
                        icon: <KeyIcon />,
                        count: 0,
                    },
                    {
                        id: "chat",
                        label: t("manageChat"),
                        icon: <ChatIcon />,
                        count: counts.chats,
                        color: "red",
                    },
                ];

                const badgeColorClass = {
                    red: "bg-red-500",
                    blue: "bg-blue-500",
                };

                return (
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 p-4">
                        {menuItems.map((item) => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className="relative bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transform transition-all duration-300 flex flex-col items-center justify-center aspect-square"
                            >
                                {item.count > 0 && (
                                    <span
                                        className={`absolute top-3 right-3 ${
                                            badgeColorClass[item.color] ||
                                            "bg-gray-400"
                                        } text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center ${
                                            item.id === "panggilan"
                                                ? "animate-pulse"
                                                : ""
                                        }`}
                                    >
                                        {item.count}
                                    </span>
                                )}
                                {item.icon}
                                <span className="text-lg font-semibold text-gray-700 text-center">
                                    {item.label}
                                </span>
                            </button>
                        ))}
                    </div>
                );
            }

            function AdminDashboard({ onLogout }) {
                const { t, language, setLanguage } = useTranslation();
                const { db, appId } = useContext(AppContext);
                const [activeTab, setActiveTab] = useState("home");
                const [callingRooms, setCallingRooms] = useState([]);
                const [unreadChatRooms, setUnreadChatRooms] = useState(
                    new Set()
                );
                const [newOrdersCount, setNewOrdersCount] = useState(0);
                const [orderNotifications, setOrderNotifications] = useState(
                    []
                );
                const [isNotificationOpen, setIsNotificationOpen] =
                    useState(false);

                const alarmSynth = useRef(null);
                const chatSynth = useRef(null);
                const orderSynth = useRef(null);
                const cancelSynth = useRef(null);
                const newOrderSynth = useRef(null);
                const alarmLoop = useRef(null);
                const newOrderLoop = useRef(null);
                const prevUnreadCount = useRef(0);

                useEffect(() => {
                    const setupAudio = async () => {
                        if (Tone.context.state !== "running")
                            await Tone.start();
                        alarmSynth.current = new Tone.Synth({
                            oscillator: { type: "square" },
                        }).toDestination();
                        chatSynth.current = new Tone.Synth().toDestination();
                        orderSynth.current = new Tone.Synth().toDestination();
                        cancelSynth.current = new Tone.Synth({
                            oscillator: { type: "triangle" },
                        }).toDestination();
                        newOrderSynth.current = new Tone.Synth({
                            oscillator: { type: "sine" },
                            envelope: {
                                attack: 0.01,
                                decay: 0.2,
                                sustain: 0.1,
                                release: 0.5,
                            },
                        }).toDestination();
                        newOrderSynth.current.volume.value = -12;
                        alarmLoop.current = new Tone.Loop((time) => {
                            alarmSynth.current.triggerAttackRelease(
                                "A5",
                                "16n",
                                time
                            );
                        }, "4n");
                        newOrderLoop.current = new Tone.Loop((time) => {
                            newOrderSynth.current.triggerAttackRelease(
                                "D4",
                                "16n",
                                time
                            );
                        }, "2s");
                    };
                    setupAudio();
                    return () => {
                        if (Tone.Transport.state === "started")
                            Tone.Transport.stop();
                        alarmLoop.current?.dispose();
                        newOrderLoop.current?.dispose();
                    };
                }, []);

                useEffect(() => {
                    if (callingRooms.length > 0) alarmLoop.current?.start(0);
                    else alarmLoop.current?.stop();
                }, [callingRooms]);

                useEffect(() => {
                    if (newOrdersCount > 0) newOrderLoop.current?.start(0);
                    else newOrderLoop.current?.stop();
                }, [newOrdersCount]);

                useEffect(() => {
                    const shouldTransportBeRunning =
                        callingRooms.length > 0 || newOrdersCount > 0;
                    if (
                        shouldTransportBeRunning &&
                        Tone.Transport.state !== "started"
                    )
                        Tone.Transport.start();
                    else if (
                        !shouldTransportBeRunning &&
                        Tone.Transport.state === "started"
                    )
                        Tone.Transport.stop();
                }, [callingRooms, newOrdersCount]);

                useEffect(() => {
                    if (unreadChatRooms.size > prevUnreadCount.current) {
                        if (
                            chatSynth.current &&
                            Tone.context.state === "running"
                        ) {
                            const now = Tone.now();
                            chatSynth.current.triggerAttackRelease(
                                "C5",
                                "8n",
                                now
                            );
                            chatSynth.current.triggerAttackRelease(
                                "G5",
                                "8n",
                                now + 0.2
                            );
                        }
                    }
                    prevUnreadCount.current = unreadChatRooms.size;
                }, [unreadChatRooms]);

                useEffect(() => {
                    if (!db) return;
                    const unsubRooms = db
                        .collection(`artifacts/${appId}/public/data/rooms`)
                        .where("isCalling", "==", true)
                        .onSnapshot((snapshot) =>
                            setCallingRooms(
                                snapshot.docs.map((d) => ({
                                    id: d.id,
                                    ...d.data(),
                                }))
                            )
                        );
                    const unsubChats = db
                        .collection(`artifacts/${appId}/public/data/chats`)
                        .where("isReadByAdmin", "==", false)
                        .onSnapshot((snapshot) =>
                            setUnreadChatRooms(
                                new Set(
                                    snapshot.docs
                                        .filter(
                                            (doc) =>
                                                doc.data().sender !== "Admin"
                                        )
                                        .map((doc) => doc.data().roomNumber)
                                )
                            )
                        );
                    const unsubOrders = db
                        .collection(`artifacts/${appId}/public/data/orders`)
                        .orderBy("timestamp", "desc")
                        .onSnapshot((snapshot) => {
                            setNewOrdersCount(
                                snapshot.docs.filter(
                                    (doc) => doc.data().status === "Baru"
                                ).length
                            );
                            snapshot.docChanges().forEach((change) => {
                                if (
                                    change.type === "added" &&
                                    change.doc.data().status === "Baru"
                                ) {
                                    setOrderNotifications((prev) => [
                                        {
                                            id: change.doc.id,
                                            type: "new",
                                            ...change.doc.data(),
                                        },
                                        ...prev,
                                    ]);
                                    if (
                                        orderSynth.current &&
                                        Tone.context.state === "running"
                                    )
                                        orderSynth.current.triggerAttackRelease(
                                            "E5",
                                            "8n"
                                        );
                                }
                                if (
                                    change.type === "modified" &&
                                    change.doc.data().status === "Dibatalkan"
                                ) {
                                    setOrderNotifications((prev) => [
                                        {
                                            id: change.doc.id,
                                            type: "cancelled",
                                            ...change.doc.data(),
                                        },
                                        ...prev,
                                    ]);
                                    if (
                                        cancelSynth.current &&
                                        Tone.context.state === "running"
                                    )
                                        cancelSynth.current.triggerAttackRelease(
                                            "C4",
                                            "8n"
                                        );
                                }
                            });
                        });
                    return () => {
                        unsubRooms();
                        unsubChats();
                        unsubOrders();
                    };
                }, [db, appId]);

                const handleReadChat = async (roomNumber) => {
                    const batch = db.batch();
                    const snapshot = await db
                        .collection(`artifacts/${appId}/public/data/chats`)
                        .where("roomNumber", "==", roomNumber)
                        .get();
                    snapshot.docs.forEach((d) => {
                        if (d.data().sender !== "Admin")
                            batch.update(d.ref, { isReadByAdmin: true });
                    });
                    await batch
                        .commit()
                        .catch((err) =>
                            console.error("Error marking chat as read:", err)
                        );
                };

                const closeNotification = (orderId) =>
                    setOrderNotifications((prev) =>
                        prev.filter((n) => n.id !== orderId)
                    );

                const renderNotificationText = (order) => {
                    if (order.type === "cancelled") {
                        return (
                            <>
                                <p className="font-bold text-sm text-red-800">
                                    {t("orderCancelledNotification")}
                                </p>
                                <p className="text-sm text-gray-600">
                                    {t("roomOrdered")} {order.roomNumber}{" "}
                                    {t("roomCancelledAnOrder")}
                                </p>
                            </>
                        );
                    }
                    return (
                        <>
                            <p className="font-bold text-sm text-gray-800">
                                {t("newOrderNotification")}
                            </p>
                            <p className="text-sm text-gray-600">
                                {t("roomOrdered")} {order.roomNumber} ordered{" "}
                                {order.items[0].name}...
                            </p>
                        </>
                    );
                };
                
                const menuNavItems = [
                    { id: "home", label: t("captainPanel") },
                    { id: "panggilan", label: t("roomCalls") },
                    { id: "pesanan", label: t("manageOrders") },
                    { id: "menu", label: t("manageMenu") },
                    { id: "kamar", label: t("manageRooms") },
                    { id: "chat", label: t("manageChat") },
                ];

                return (
                    <div className="flex flex-col h-screen bg-gray-100">
                        <header className="bg-white shadow-md p-4 flex justify-between items-center w-full flex-shrink-0 flex-wrap">
                            <nav className="flex items-center space-x-2 sm:space-x-4 flex-wrap">
                                {menuNavItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setActiveTab(item.id)}
                                        className={`relative px-3 py-2 my-1 rounded-md transition-colors duration-200 text-sm font-medium ${
                                            activeTab === item.id
                                                ? "bg-blue-600 text-white"
                                                : "text-gray-600 hover:bg-gray-200"
                                        }`}
                                    >
                                        {item.label}
                                        {item.id === 'panggilan' && callingRooms.length > 0 && (
                                            <span className="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                                        )}
                                    </button>
                                ))}
                            </nav>
                            <div className="flex items-center space-x-2 sm:space-x-4 mt-2 sm:mt-0 ml-auto">
                                <button
                                    onClick={() =>
                                        setLanguage((lang) =>
                                            lang === "id" ? "en" : "id"
                                        )
                                    }
                                    className="flex items-center justify-center space-x-2 p-2 rounded-full hover:bg-gray-100"
                                    title="Switch Language"
                                >
                                    {language === "id" ? (
                                        <FlagUK />
                                    ) : (
                                        <FlagIndonesia />
                                    )}
                                </button>
                                <button
                                    onClick={onLogout}
                                    title={t("logout")}
                                    className="p-2 rounded-full hover:bg-gray-100 text-gray-600"
                                >
                                    <LogoutIcon />
                                </button>
                                <div className="relative">
                                    <button
                                        onClick={() =>
                                            setIsNotificationOpen(
                                                (prev) => !prev
                                            )
                                        }
                                        className="relative p-2 rounded-full bg-gray-100 hover:bg-gray-200"
                                    >
                                        <svg
                                            className="w-6 h-6 text-gray-600"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                                strokeWidth="2"
                                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                                            ></path>
                                        </svg>
                                        {orderNotifications.length > 0 && (
                                            <span className="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                                                {orderNotifications.length}
                                            </span>
                                        )}
                                    </button>
                                    {isNotificationOpen && (
                                        <div className="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-20">
                                            <div className="p-4 font-bold border-b">
                                                {t("notifications")}
                                            </div>
                                            <div className="max-h-96 overflow-y-auto">
                                                {orderNotifications.length >
                                                0 ? (
                                                    orderNotifications.map(
                                                        (order) => (
                                                            <div
                                                                key={
                                                                    order.id +
                                                                    order.type
                                                                }
                                                                className={`p-4 border-b hover:bg-gray-50 flex items-start ${
                                                                    order.type ===
                                                                    "cancelled"
                                                                        ? "bg-red-50"
                                                                        : ""
                                                                }`}
                                                            >
                                                                <div className="ml-3 flex-1">
                                                                    {renderNotificationText(
                                                                        order
                                                                    )}
                                                                    <p className="text-xs text-gray-400 mt-1">
                                                                        {order.timestamp
                                                                            ? new Date(
                                                                                  order.timestamp.toDate()
                                                                              ).toLocaleTimeString()
                                                                            : ""}
                                                                    </p>
                                                                </div>
                                                                <button
                                                                    onClick={(
                                                                        e
                                                                    ) => {
                                                                        e.stopPropagation();
                                                                        closeNotification(
                                                                            order.id
                                                                        );
                                                                    }}
                                                                    className="ml-2 p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600"
                                                                >
                                                                    <svg
                                                                        className="w-4 h-4"
                                                                        fill="currentColor"
                                                                        viewBox="0 0 20 20"
                                                                    >
                                                                        <path
                                                                            fillRule="evenodd"
                                                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                                            clipRule="evenodd"
                                                                        ></path>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        )
                                                    )
                                                ) : (
                                                    <p className="p-4 text-sm text-gray-500">
                                                        {t(
                                                            "noNewNotifications"
                                                        )}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </header>
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                            {activeTab === "home" && (
                                <MainMenu
                                    setActiveTab={setActiveTab}
                                    counts={{
                                        calls: callingRooms.length,
                                        orders: newOrdersCount,
                                        chats: unreadChatRooms.size,
                                    }}
                                />
                            )}
                            {activeTab === "panggilan" && (
                                <ManageCalls callingRooms={callingRooms} />
                            )}
                            {activeTab === "pesanan" && (
                                <ManageOrders
                                    onUpdateStatus={closeNotification}
                                />
                            )}
                            {activeTab === "menu" && <ManageMenu />}
                            {activeTab === "kamar" && <ManageRooms />}
                            {activeTab === "chat" && (
                                <AdminChat
                                    onRoomSelect={handleReadChat}
                                    unreadRooms={unreadChatRooms}
                                />
                            )}
                        </main>
                    </div>
                );
            }

            function ManageCalls({ callingRooms }) {
                const { db, appId } = useContext(AppContext);
                const { t } = useTranslation();
                const handleAcknowledge = async (roomId) => {
                    const roomRef = db
                        .collection(`artifacts/${appId}/public/data/rooms`)
                        .doc(roomId);
                    await roomRef.update({ isCalling: false });
                };
                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6">
                            {t("callsFromRoom")}
                        </h2>
                        {callingRooms.length === 0 ? (
                            <p className="text-gray-600">
                                {t("noCurrentCalls")}
                            </p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {callingRooms.map((room) => (
                                    <div
                                        key={room.id}
                                        className="bg-red-100 border-2 border-red-500 rounded-lg p-6 shadow-lg animate-pulse"
                                    >
                                        <h3 className="text-2xl font-bold text-red-800">
                                            {t("emergencyCall")}
                                        </h3>
                                        <p className="text-red-700 mt-2 text-lg">
                                            {t("roomOrdered")}{" "}
                                            <span className="font-bold">
                                                {room.displayName || room.name}
                                            </span>{" "}
                                            {t("needsAssistance")}
                                        </p>
                                        <button
                                            onClick={() =>
                                                handleAcknowledge(room.id)
                                            }
                                            className="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors"
                                        >
                                            {t("markAsDone")}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            }

            function ManageOrders({ onUpdateStatus }) {
                const { db, appId } = useContext(AppContext);
                const { t } = useTranslation();
                const [orders, setOrders] = useState([]);
                const [loading, setLoading] = useState(true);
                const [filter, setFilter] = useState("Semua");

                useEffect(() => {
                    if (!db) return;
                    const ordersRef = db.collection(
                        `artifacts/${appId}/public/data/orders`
                    );
                    const unsubscribe = ordersRef.onSnapshot((snapshot) => {
                        const fetchedOrders = snapshot.docs.map((d) => ({
                            id: d.id,
                            ...d.data(),
                        }));
                        fetchedOrders.sort(
                            (a, b) =>
                                (b.timestamp?.seconds || 0) -
                                (a.timestamp?.seconds || 0)
                        );
                        setOrders(fetchedOrders);
                        setLoading(false);
                    });
                    return () => unsubscribe();
                }, [db, appId]);

                const updateOrderStatus = async (orderId, newStatus) => {
                    const orderRef = db
                        .collection(`artifacts/${appId}/public/data/orders`)
                        .doc(orderId);
                    await orderRef.update({
                        status: newStatus,
                        isReadByCustomer: false,
                        isNew: false,
                    });
                    if (newStatus !== "Baru") onUpdateStatus(orderId);
                };

                const filteredOrders = orders.filter(
                    (order) => filter === "Semua" || order.status === filter
                );

                if (loading) return <p>Loading orders...</p>;

                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6">
                            {t("manageOrders")}
                        </h2>
                        <div className="flex flex-wrap gap-2 mb-4">
                            {[
                                "Semua",
                                "Baru",
                                "Diproses",
                                "Selesai",
                                "Dibatalkan",
                            ].map((status) => (
                                <button
                                    key={status}
                                    onClick={() => setFilter(status)}
                                    className={`px-4 py-2 rounded-lg flex-shrink-0 ${
                                        filter === status
                                            ? "bg-blue-600 text-white"
                                            : "bg-white"
                                    }`}
                                >
                                    {t(
                                        status === "Semua"
                                            ? "all"
                                            : `status_${status}`
                                    )}
                                </button>
                            ))}
                        </div>
                        <div className="space-y-4">
                            {filteredOrders.length === 0 ? (
                                <p>
                                    {t("noOrdersWithStatus")} "
                                    {t(
                                        filter === "Semua"
                                            ? "all"
                                            : `status_${filter}`
                                    )}
                                    ".
                                </p>
                            ) : (
                                filteredOrders.map((order) => (
                                    <div
                                        key={order.id}
                                        className="bg-white p-4 rounded-lg shadow"
                                    >
                                        <div className="flex flex-col sm:flex-row justify-between sm:items-center mb-2">
                                            <h3 className="font-bold text-lg">
                                                {t("orderFromRoom")}{" "}
                                                {order.roomNumber}
                                            </h3>
                                            <p className="text-sm text-gray-500">
                                                {order.timestamp
                                                    ? new Date(
                                                          order.timestamp.toDate()
                                                      ).toLocaleString()
                                                    : "N/A"}
                                            </p>
                                        </div>
                                        <div className="border-t border-b py-2 my-2">
                                            {order.items.map((item) => (
                                                <div
                                                    key={item.cartId}
                                                    className="flex justify-between text-sm py-1"
                                                >
                                                    <div>
                                                        <p>
                                                            {item.name}{" "}
                                                            {item.selectedAddOns
                                                                ?.length > 0 &&
                                                                `(${item.selectedAddOns
                                                                    .map(
                                                                        (ao) =>
                                                                            ao.name
                                                                    )
                                                                    .join(
                                                                        ", "
                                                                    )})`}
                                                        </p>
                                                        {item.note && (
                                                            <p className="text-xs text-gray-500 italic pl-2">
                                                                - "{item.note}"
                                                            </p>
                                                        )}
                                                    </div>
                                                    <span>
                                                        Rp
                                                        {item.price.toLocaleString(
                                                            "id-ID"
                                                        )}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex flex-col sm:flex-row justify-between sm:items-center mt-2">
                                            <p className="font-bold mb-2 sm:mb-0">
                                                {t("total")} Rp
                                                {order.total.toLocaleString(
                                                    "id-ID"
                                                )}
                                            </p>
                                            <div className="flex items-center space-x-2">
                                                <label
                                                    htmlFor={`status-${order.id}`}
                                                    className="text-sm"
                                                >
                                                    {t("status")}
                                                </label>
                                                <select
                                                    id={`status-${order.id}`}
                                                    value={order.status}
                                                    onChange={(e) =>
                                                        updateOrderStatus(
                                                            order.id,
                                                            e.target.value
                                                        )
                                                    }
                                                    className="p-1 border rounded"
                                                >
                                                    <option value="Baru">
                                                        {t("new")}
                                                    </option>
                                                    <option value="Diproses">
                                                        {t("processing")}
                                                    </option>
                                                    <option value="Selesai">
                                                        {t("completed")}
                                                    </option>
                                                    <option value="Dibatalkan">
                                                        {t("cancelled")}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                );
            }

            function ManageRooms() {
                const { db, appId } = useContext(AppContext);
                const { t } = useTranslation();
                const [rooms, setRooms] = useState([]);
                const [editingRoom, setEditingRoom] = useState(null);
                const [newRoomData, setNewRoomData] = useState({
                    name: "",
                    displayName: "",
                    title: "Mr.",
                });
                const [editRoomData, setEditRoomData] = useState({
                    displayName: "",
                    title: "",
                });
                const [showDeleteModal, setShowDeleteModal] = useState(false);
                const [roomToDelete, setRoomToDelete] = useState(null);
                const [error, setError] = useState("");

                useEffect(() => {
                    if (!db) return;
                    const roomsRef = db.collection(
                        `artifacts/${appId}/public/data/rooms`
                    );
                    const unsubscribe = roomsRef.onSnapshot((snapshot) => {
                        const fetchedRooms = snapshot.docs.map((d) => ({
                            id: d.id,
                            ...d.data(),
                        }));
                        fetchedRooms.sort((a, b) =>
                            a.name.localeCompare(b.name)
                        );
                        setRooms(fetchedRooms);
                    });
                    return () => unsubscribe();
                }, [db, appId]);

                const handleAddRoom = async () => {
                    setError("");
                    if (!newRoomData.name.trim()) {
                        setError("Room name cannot be empty.");
                        return;
                    }
                    const roomNameUpper = newRoomData.name.trim().toUpperCase();
                    const roomsRef = db.collection(
                        `artifacts/${appId}/public/data/rooms`
                    );
                    const q = roomsRef.where("name", "==", roomNameUpper);
                    const snapshot = await q.get();
                    if (!snapshot.empty) {
                        setError(
                            `Room with name ${roomNameUpper} already exists.`
                        );
                        return;
                    }
                    await roomsRef.add({
                        name: roomNameUpper,
                        displayName:
                            newRoomData.displayName.trim() || roomNameUpper,
                        title: newRoomData.title,
                        isCalling: false,
                    });
                    setNewRoomData({ name: "", displayName: "", title: "Mr." });
                };

                const handleDeleteRoom = async () => {
                    if (!roomToDelete) return;
                    await db
                        .collection(`artifacts/${appId}/public/data/rooms`)
                        .doc(roomToDelete.id)
                        .delete();
                    setShowDeleteModal(false);
                    setRoomToDelete(null);
                };

                const handleSaveName = async () => {
                    if (!editingRoom) return;
                    const roomRef = db
                        .collection(`artifacts/${appId}/public/data/rooms`)
                        .doc(editingRoom.id);
                    await roomRef.update({
                        displayName: editRoomData.displayName.trim(),
                        title: editRoomData.title,
                    });
                    setEditingRoom(null);
                };

                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6">
                            {t("manageRooms")}
                        </h2>
                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-xl font-bold mb-4">
                                {t("addNewRoom")}
                            </h3>
                            {error && (
                                <p className="text-red-500 mb-4">{error}</p>
                            )}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input
                                    type="text"
                                    name="name"
                                    value={newRoomData.name}
                                    onChange={(e) =>
                                        setNewRoomData({
                                            ...newRoomData,
                                            name: e.target.value,
                                        })
                                    }
                                    className="p-2 border rounded"
                                    placeholder={t("roomName")}
                                />
                                <select
                                    name="title"
                                    value={newRoomData.title}
                                    onChange={(e) =>
                                        setNewRoomData({
                                            ...newRoomData,
                                            title: e.target.value,
                                        })
                                    }
                                    className="p-2 border rounded"
                                >
                                    <option value="Mr.">Mr.</option>
                                    <option value="Mrs.">Mrs.</option>
                                </select>
                                <input
                                    type="text"
                                    name="displayName"
                                    value={newRoomData.displayName}
                                    onChange={(e) =>
                                        setNewRoomData({
                                            ...newRoomData,
                                            displayName: e.target.value,
                                        })
                                    }
                                    className="p-2 border rounded"
                                    placeholder={t("displayName")}
                                />
                            </div>
                            <button
                                onClick={handleAddRoom}
                                className="mt-4 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700"
                            >
                                {t("addRoom")}
                            </button>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h3 className="text-xl font-bold mb-4">
                                {t("roomList")}
                            </h3>
                            <ul className="space-y-3">
                                {rooms.map((room) => (
                                    <li
                                        key={room.id}
                                        className="flex items-center justify-between p-3 bg-gray-50 rounded"
                                    >
                                        <div>
                                            <span className="font-bold text-gray-700">
                                                {room.name}
                                            </span>
                                            <span className="text-gray-500 ml-4">
                                                {t("displayLabel")}{" "}
                                                {room.title || ""}{" "}
                                                {room.displayName ||
                                                    t("notSet")}
                                            </span>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => {
                                                    setEditingRoom(room);
                                                    setEditRoomData({
                                                        displayName:
                                                            room.displayName ||
                                                            "",
                                                        title:
                                                            room.title || "Mr.",
                                                    });
                                                }}
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded"
                                            >
                                                {t("edit")}
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setRoomToDelete(room);
                                                    setShowDeleteModal(true);
                                                }}
                                                className="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded"
                                            >
                                                {t("delete")}
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        {editingRoom && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
                                <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                                    <h3 className="text-xl font-bold mb-4">
                                        {t("editRoomDetails")}{" "}
                                        {editingRoom.name}
                                    </h3>
                                    <div className="space-y-4">
                                        <select
                                            name="title"
                                            value={editRoomData.title}
                                            onChange={(e) =>
                                                setEditRoomData({
                                                    ...editRoomData,
                                                    title: e.target.value,
                                                })
                                            }
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="Mr.">Mr.</option>
                                            <option value="Mrs.">Mrs.</option>
                                        </select>
                                        <input
                                            type="text"
                                            name="displayName"
                                            value={editRoomData.displayName}
                                            onChange={(e) =>
                                                setEditRoomData({
                                                    ...editRoomData,
                                                    displayName: e.target.value,
                                                })
                                            }
                                            className="w-full p-2 border rounded"
                                            placeholder={t("enterNewName")}
                                        />
                                    </div>
                                    <div className="mt-4 flex justify-end space-x-2">
                                        <button
                                            onClick={() => setEditingRoom(null)}
                                            className="bg-gray-300 px-4 py-2 rounded"
                                        >
                                            {t("cancel")}
                                        </button>
                                        <button
                                            onClick={handleSaveName}
                                            className="bg-blue-600 text-white px-4 py-2 rounded"
                                        >
                                            {t("save")}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        <ConfirmationModal
                            show={showDeleteModal}
                            message={`${t("confirmDeleteRoom")} ${
                                roomToDelete?.name
                            }? ${t("thisActionCannotBeUndone")}`}
                            onConfirm={handleDeleteRoom}
                            onCancel={() => setShowDeleteModal(false)}
                        />
                    </div>
                );
            }

            function ItemForm({
                item,
                isEditing,
                onSubmit,
                onCancel,
                handleInputChange,
                handleAddOnFieldChange,
                handleAddAddOnField,
                handleRemoveAddOnField,
                categories,
            }) {
                const { t } = useTranslation();
                return (
                    <form
                        onSubmit={onSubmit}
                        className="bg-white p-6 rounded-lg shadow-md mb-8"
                    >
                        <h3 className="text-xl font-bold mb-4">
                            {isEditing
                                ? t("editMenuItem")
                                : t("addNewMenuItem")}
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input
                                type="text"
                                name="name"
                                value={item.name}
                                onChange={(e) =>
                                    handleInputChange(e, isEditing)
                                }
                                placeholder={t("itemNamePlaceholder")}
                                className="p-2 border rounded"
                                required
                            />
                            <input
                                type="number"
                                name="price"
                                value={item.price}
                                onChange={(e) =>
                                    handleInputChange(e, isEditing)
                                }
                                placeholder={t("pricePlaceholder")}
                                className="p-2 border rounded"
                                required
                            />
                            <textarea
                                name="description"
                                value={item.description}
                                onChange={(e) =>
                                    handleInputChange(e, isEditing)
                                }
                                placeholder={t("descriptionPlaceholder")}
                                className="p-2 border rounded md:col-span-2"
                            />
                            <select
                                name="category"
                                value={item.category}
                                onChange={(e) =>
                                    handleInputChange(e, isEditing)
                                }
                                className="p-2 border rounded"
                            >
                                {categories.map((cat) => (
                                    <option key={cat} value={cat}>
                                        {cat}
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div className="mt-6">
                            <h4 className="font-bold mb-2">{t("addons")}</h4>
                            {(item.addOns || []).map((addOn, index) => (
                                <div
                                    key={index}
                                    className="flex items-center space-x-2 mb-2"
                                >
                                    <input
                                        type="text"
                                        name="name"
                                        value={addOn.name}
                                        onChange={(e) =>
                                            handleAddOnFieldChange(
                                                index,
                                                e,
                                                isEditing
                                            )
                                        }
                                        placeholder={t("addonNamePlaceholder")}
                                        className="flex-grow p-2 border rounded"
                                    />
                                    <input
                                        type="number"
                                        name="price"
                                        value={addOn.price}
                                        onChange={(e) =>
                                            handleAddOnFieldChange(
                                                index,
                                                e,
                                                isEditing
                                            )
                                        }
                                        placeholder={t("addonPricePlaceholder")}
                                        className="w-32 p-2 border rounded"
                                    />
                                    <button
                                        type="button"
                                        onClick={() =>
                                            handleRemoveAddOnField(
                                                index,
                                                isEditing
                                            )
                                        }
                                        className="bg-red-500 text-white px-3 py-1 rounded"
                                    >
                                        &times;
                                    </button>
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={() => handleAddAddOnField(isEditing)}
                                className="bg-gray-200 px-4 py-2 rounded text-sm mt-2"
                            >
                                {t("addAddon")}
                            </button>
                        </div>
                        <div className="mt-6 flex space-x-2">
                            <button
                                type="submit"
                                className="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700"
                            >
                                {isEditing ? t("saveChanges") : t("addItem")}
                            </button>
                            {isEditing && (
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600"
                                >
                                    {t("cancel")}
                                </button>
                            )}
                        </div>
                    </form>
                );
            }

            function ManageMenu() {
                const { db, appId } = useContext(AppContext);
                const { t } = useTranslation();
                const [items, setItems] = useState([]);
                const [newItem, setNewItem] = useState({
                    name: "",
                    description: "",
                    price: "",
                    category: "Makanan",
                    addOns: [],
                });
                const [editingItem, setEditingItem] = useState(null);
                const [showDeleteModal, setShowDeleteModal] = useState(false);
                const [itemToDelete, setItemToDelete] = useState(null);
                const [error, setError] = useState("");

                const categories = [
                    "Makanan",
                    "Minuman",
                    "Dessert",
                    "Alcohol",
                    "Lainlain",
                ];

                useEffect(() => {
                    const itemsRef = db.collection(
                        `artifacts/${appId}/public/data/items`
                    );
                    const q = itemsRef.orderBy("name");
                    const unsubscribe = q.onSnapshot((snapshot) => {
                        setItems(
                            snapshot.docs.map((d) => ({
                                id: d.id,
                                ...d.data(),
                            }))
                        );
                    });
                    return () => unsubscribe();
                }, [db, appId]);

                const handleInputChange = (e, isEditing = false) => {
                    const { name, value } = e.target;
                    const targetState = isEditing ? editingItem : newItem;
                    const setState = isEditing ? setEditingItem : setNewItem;
                    setState({ ...targetState, [name]: value });
                };

                const handleAddOnFieldChange = (
                    index,
                    e,
                    isEditing = false
                ) => {
                    const { name, value } = e.target;
                    const targetState = isEditing ? editingItem : newItem;
                    const setState = isEditing ? setEditingItem : setNewItem;
                    const updatedAddOns = targetState.addOns.map((addOn, i) =>
                        i === index ? { ...addOn, [name]: value } : addOn
                    );
                    setState({ ...targetState, addOns: updatedAddOns });
                };

                const handleAddAddOnField = (isEditing = false) => {
                    const targetState = isEditing ? editingItem : newItem;
                    const setState = isEditing ? setEditingItem : setNewItem;
                    setState({
                        ...targetState,
                        addOns: [
                            ...(targetState.addOns || []),
                            { name: "", price: "" },
                        ],
                    });
                };

                const handleRemoveAddOnField = (index, isEditing = false) => {
                    const targetState = isEditing ? editingItem : newItem;
                    const setState = isEditing ? setEditingItem : setNewItem;
                    const updatedAddOns = targetState.addOns.filter(
                        (_, i) => i !== index
                    );
                    setState({ ...targetState, addOns: updatedAddOns });
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setError("");
                    const itemData = editingItem || newItem;
                    if (!itemData.name || !itemData.price) {
                        setError("Name and Price cannot be empty.");
                        return;
                    }
                    const price = parseFloat(itemData.price);
                    if (isNaN(price)) {
                        setError("Price must be a number.");
                        return;
                    }
                    const finalAddOns = (itemData.addOns || [])
                        .filter((ao) => ao.name && ao.price)
                        .map((ao) => ({
                            name: ao.name,
                            price: parseFloat(ao.price),
                        }));
                    const dataToSave = {
                        name: itemData.name,
                        description: itemData.description || "",
                        price,
                        category: itemData.category,
                        addOns: finalAddOns,
                    };

                    if (editingItem) {
                        await db
                            .collection(`artifacts/${appId}/public/data/items`)
                            .doc(editingItem.id)
                            .update(dataToSave);
                        setEditingItem(null);
                    } else {
                        await db
                            .collection(`artifacts/${appId}/public/data/items`)
                            .add(dataToSave);
                        setNewItem({
                            name: "",
                            description: "",
                            price: "",
                            category: "Makanan",
                            addOns: [],
                        });
                    }
                };

                const handleDelete = async () => {
                    if (!itemToDelete) return;
                    await db
                        .collection(`artifacts/${appId}/public/data/items`)
                        .doc(itemToDelete.id)
                        .delete();
                    setShowDeleteModal(false);
                    setItemToDelete(null);
                };

                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6">
                            {t("manageMenu")}
                        </h2>
                        {error && <p className="text-red-500 mb-4">{error}</p>}
                        {editingItem ? (
                            <ItemForm
                                item={editingItem}
                                isEditing={true}
                                onSubmit={handleSubmit}
                                onCancel={() => setEditingItem(null)}
                                {...{
                                    handleInputChange,
                                    handleAddOnFieldChange,
                                    handleAddAddOnField,
                                    handleRemoveAddOnField,
                                    categories,
                                }}
                            />
                        ) : (
                            <ItemForm
                                item={newItem}
                                isEditing={false}
                                onSubmit={handleSubmit}
                                {...{
                                    handleInputChange,
                                    handleAddOnFieldChange,
                                    handleAddAddOnField,
                                    handleRemoveAddOnField,
                                    categories,
                                }}
                            />
                        )}
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h3 className="text-xl font-bold mb-4">
                                {t("menuList")}
                            </h3>
                            <div className="space-y-3">
                                {items.map((item) => (
                                    <div
                                        key={item.id}
                                        className="p-3 bg-gray-50 rounded flex justify-between items-start"
                                    >
                                        <div>
                                            <p className="font-bold text-gray-800">
                                                {item.name}{" "}
                                                <span className="text-sm font-normal text-gray-500">
                                                    ({item.category})
                                                </span>
                                            </p>
                                            <p className="text-sm text-gray-600">
                                                {item.description}
                                            </p>
                                            <p
                                                className={`font-semibold mt-1 ${
                                                    item.price === 0
                                                        ? "text-green-600"
                                                        : "text-blue-600"
                                                }`}
                                            >
                                                {item.price === 0
                                                    ? "Gratis"
                                                    : `Rp${item.price.toLocaleString(
                                                          "id-ID"
                                                      )}`}
                                            </p>
                                            {item.addOns &&
                                                item.addOns.length > 0 && (
                                                    <ul className="text-xs list-disc list-inside mt-1">
                                                        {item.addOns.map(
                                                            (ao) => (
                                                                <li
                                                                    key={
                                                                        ao.name
                                                                    }
                                                                >
                                                                    {ao.name}{" "}
                                                                    (+Rp
                                                                    {ao.price.toLocaleString(
                                                                        "id-ID"
                                                                    )}
                                                                    )
                                                                </li>
                                                            )
                                                        )}
                                                    </ul>
                                                )}
                                        </div>
                                        <div className="flex space-x-2 flex-shrink-0">
                                            <button
                                                onClick={() =>
                                                    setEditingItem(item)
                                                }
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded text-sm"
                                            >
                                                {t("edit")}
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setItemToDelete(item);
                                                    setShowDeleteModal(true);
                                                }}
                                                className="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded text-sm"
                                            >
                                                {t("delete")}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <ConfirmationModal
                            show={showDeleteModal}
                            message={`${t("confirmDeleteItem")} ${
                                itemToDelete?.name
                            }?`}
                            onConfirm={handleDelete}
                            onCancel={() => setShowDeleteModal(false)}
                        />
                    </div>
                );
            }

            function AdminChat({ onRoomSelect, unreadRooms }) {
                const { db, appId } = useContext(AppContext);
                const { t } = useTranslation();
                const [messages, setMessages] = useState([]);
                const [selectedRoom, setSelectedRoom] = useState(null);
                const [newMessage, setNewMessage] = useState("");
                const [roomMap, setRoomMap] = useState({});
                const messagesEndRef = useRef(null);
                const [showClearModal, setShowClearModal] = useState(false);

                useEffect(() => {
                    if (!db) return;
                    const roomsRef = db.collection(
                        `artifacts/${appId}/public/data/rooms`
                    );
                    const unsubRooms = roomsRef.onSnapshot((snapshot) => {
                        const newRoomMap = {};
                        snapshot.docs.forEach((d) => {
                            newRoomMap[d.data().name] = d.data();
                        });
                        setRoomMap(newRoomMap);
                    });

                    const chatsRef = db.collection(
                        `artifacts/${appId}/public/data/chats`
                    );
                    const q = chatsRef; // No orderBy to avoid index
                    const unsubChats = q.onSnapshot((snapshot) => {
                        const allMessages = snapshot.docs.map((d) => ({
                            id: d.id,
                            ...d.data(),
                        }));
                        setMessages(allMessages);
                    });
                    return () => {
                        unsubRooms();
                        unsubChats();
                    };
                }, [db, appId]);

                useEffect(() => {
                    messagesEndRef.current?.scrollIntoView({
                        behavior: "smooth",
                    });
                }, [messages, selectedRoom]);

                const groupedMessages = messages.reduce((acc, msg) => {
                    (acc[msg.roomNumber] = acc[msg.roomNumber] || []).push(msg);
                    return acc;
                }, {});

                for (const room in groupedMessages) {
                    groupedMessages[room].sort(
                        (a, b) =>
                            (a.timestamp?.toDate() || 0) -
                            (b.timestamp?.toDate() || 0)
                    );
                }

                const roomList = Object.keys(groupedMessages).sort();

                const handleSelectRoom = (room) => {
                    setSelectedRoom(room);
                    onRoomSelect(room);
                };

                const handleSendMessage = async () => {
                    if (!newMessage.trim() || !selectedRoom) return;
                    await db
                        .collection(`artifacts/${appId}/public/data/chats`)
                        .add({
                            roomNumber: selectedRoom,
                            sender: "Admin",
                            message: newMessage.trim(),
                            timestamp:
                                firebase.firestore.FieldValue.serverTimestamp(),
                            isReadByAdmin: true,
                        });
                    setNewMessage("");
                };

                const handleClearChat = async () => {
                    if (!selectedRoom) return;
                    const q = db
                        .collection(`artifacts/${appId}/public/data/chats`)
                        .where("roomNumber", "==", selectedRoom);
                    const snapshot = await q.get();
                    const batch = db.batch();
                    snapshot.docs.forEach((d) => batch.delete(d.ref));
                    await batch.commit();
                    setShowClearModal(false);
                };

                return (
                    <div className="flex h-[80vh] bg-white rounded-lg shadow-md overflow-hidden">
                        <div
                            className={`w-full md:w-1/3 border-r border-gray-200 flex flex-col transition-transform duration-300 ${
                                selectedRoom && "hidden md:flex"
                            }`}
                        >
                            <h3 className="text-xl font-bold p-4 border-b">
                                {t("messagesFromRoom")}
                            </h3>
                            <ul className="overflow-y-auto">
                                {roomList.map((room) => (
                                    <li key={room}>
                                        <button
                                            onClick={() =>
                                                handleSelectRoom(room)
                                            }
                                            className={`w-full text-left p-4 hover:bg-gray-100 flex justify-between items-center ${
                                                selectedRoom === room
                                                    ? "bg-blue-100"
                                                    : ""
                                            }`}
                                        >
                                            <span
                                                className={
                                                    selectedRoom === room
                                                        ? "font-bold"
                                                        : ""
                                                }
                                            >
                                                {room} (
                                                {roomMap[room]?.title || ""}{" "}
                                                {roomMap[room]?.displayName ||
                                                    "..."}
                                                )
                                            </span>
                                            {unreadRooms.has(room) && (
                                                <span className="w-3 h-3 bg-red-500 rounded-full"></span>
                                            )}
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        <div
                            className={`w-full md:w-2/3 flex flex-col ${
                                !selectedRoom && "hidden md:flex"
                            }`}
                        >
                            {selectedRoom ? (
                                <>
                                    <div className="p-4 border-b flex justify-between items-center">
                                        <div className="flex items-center space-x-2">
                                            <button
                                                onClick={() =>
                                                    setSelectedRoom(null)
                                                }
                                                className="md:hidden p-1 rounded-full hover:bg-gray-200"
                                            >
                                                <svg
                                                    className="w-5 h-5"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        strokeLinecap="round"
                                                        strokeLinejoin="round"
                                                        strokeWidth="2"
                                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"
                                                    ></path>
                                                </svg>
                                            </button>
                                            <span className="font-bold text-lg">
                                                {t("chatWithRoom")}{" "}
                                                {selectedRoom}
                                            </span>
                                        </div>
                                        <button
                                            onClick={() =>
                                                setShowClearModal(true)
                                            }
                                            className="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                                        >
                                            {t("clearChat")}
                                        </button>
                                    </div>
                                    <div className="flex-grow p-4 overflow-y-auto bg-gray-50">
                                        {groupedMessages[selectedRoom]?.map(
                                            (msg) => (
                                                <div
                                                    key={msg.id}
                                                    className={`flex mb-3 ${
                                                        msg.sender === "Admin"
                                                            ? "justify-end"
                                                            : "justify-start"
                                                    }`}
                                                >
                                                    <div
                                                        className={`p-3 rounded-lg max-w-[70%] ${
                                                            msg.sender ===
                                                            "Admin"
                                                                ? "bg-blue-500 text-white"
                                                                : "bg-gray-300 text-gray-800"
                                                        }`}
                                                    >
                                                        <p className="font-bold text-sm mb-1">
                                                            {msg.sender === "Admin" ? "Admin" : (roomMap[msg.sender]?.displayName || msg.sender)}
                                                        </p>
                                                        <p>{msg.message}</p>
                                                        <span className="text-xs opacity-75 mt-1 block text-right">
                                                            {msg.timestamp
                                                                ? new Date(
                                                                      msg.timestamp.toDate()
                                                                  ).toLocaleTimeString()
                                                                : "sending..."}
                                                        </span>
                                                    </div>
                                                </div>
                                            )
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                    <div className="p-4 bg-white border-t flex">
                                        <input
                                            type="text"
                                            value={newMessage}
                                            onChange={(e) =>
                                                setNewMessage(e.target.value)
                                            }
                                            onKeyPress={(e) =>
                                                e.key === "Enter" &&
                                                handleSendMessage()
                                            }
                                            className="flex-grow p-2 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder={t("typeReply")}
                                        />
                                        <button
                                            onClick={handleSendMessage}
                                            className="bg-blue-600 text-white px-6 rounded-r-md hover:bg-blue-700"
                                        >
                                            {t("send")}
                                        </button>
                                    </div>
                                </>
                            ) : (
                                <div className="flex-grow flex items-center justify-center text-gray-500">
                                    {t("chooseRoomToSeeConversation")}
                                </div>
                            )}
                        </div>
                        <ConfirmationModal
                            show={showClearModal}
                            message={`${t(
                                "confirmClearChat"
                            )} ${selectedRoom}?`}
                            onConfirm={handleClearChat}
                            onCancel={() => setShowClearModal(false)}
                        />
                    </div>
                );
            }

            const container = document.getElementById("root");
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        </script>
    </body>
</html>
